
use v6.d;
use lib 'lib';
use ORM::ActiveRecord;

use Test;

class User is ActiveRecord {
  submethod BUILD {
    self.validate: 'fname', {
      :presence,
      length => { min => 4, max => 32 }
    }
  }
}

plan 51;

my User $user;

# build
$user = User.build;
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['at least 4 characters required', 'must be present'];

$user = User.build({});
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['must be present', 'at least 4 characters required'];

$user = User.build({fname => 'x' x 33});
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['only 32 characters allowed'];

$user = User.build({fname => 'Greg'});
ok $user.id == 0;
ok $user.is-valid;

# build && save
$user = User.build;
nok $user.save;
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['at least 4 characters required', 'must be present'];

$user = User.build({});
nok $user.save;
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['must be present', 'at least 4 characters required'];

$user = User.build({fname => 'x' x 33});
nok $user.save;
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['only 32 characters allowed'];

$user = User.build({fname => 'Greg'});
ok $user.save;
ok $user.id != 0;
ok $user.is-valid;

# create
$user = User.create;
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['at least 4 characters required', 'must be present'];

$user = User.create({});
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['must be present', 'at least 4 characters required'];

$user = User.create({fname => 'x' x 33});
nok $user.is-valid;
ok $user.id == 0;
ok $user.errors.fname == ['only 32 characters allowed'];

$user = User.create({fname => 'Greg'});
ok $user.id != 0;
ok $user.is-valid;

# update
$user = User.create({fname => 'Fred'});
ok $user.id != 0;
ok $user.is-valid;

ok $user.update({fname => 'Greg'});
ok $user.is-valid;
ok $user.fname eq 'Greg';

nok $user.update({fname => 'x'});
nok $user.is-valid;
ok $user.errors.fname == ['at least 4 characters required'];

nok $user.update({fname => Nil});
nok $user.is-valid;
ok $user.errors.fname == ['must be present', 'at least 4 characters required'];

nok $user.update({fname => 'x' x 33});
nok $user.is-valid;
ok $user.errors.fname == ['only 32 characters allowed'];
